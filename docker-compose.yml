services:
  # CPU Pipeline Execution
  pvbesscar-pipeline:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - BUILDKIT_INLINE_CACHE=1
    image: pvbesscar:latest
    container_name: pvbesscar-pipeline
    hostname: pvbesscar-pipeline
    
    # Mount volumes for persistence
    volumes:
      - ./data:/app/data                    # Input/Output data
      - ./outputs:/app/outputs              # Results & checkpoints
      - ./configs:/app/configs:ro           # Configuration (read-only)
      - pipeline_cache:/app/.cache          # Pip cache for faster rebuilds
    
    # Environment variables
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - OMP_NUM_THREADS=4
      - PYTHONPATH=/app/src:/app
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '8'
          memory: 32G
        reservations:
          cpus: '4'
          memory: 16G
    
    # Restart policy
    restart: unless-stopped
    
    # Logging with rotation
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        labels: "service=pipeline"
    
    # Interactive terminal (for debugging)
    stdin_open: true
    tty: true
    
    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import stable_baselines3; print('OK')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  # Checkpoint monitoring service
  pvbesscar-monitor:
    build:
      context: .
      dockerfile: Dockerfile
    image: pvbesscar:latest
    container_name: pvbesscar-monitor
    hostname: pvbesscar-monitor
    
    depends_on:
      pvbesscar-pipeline:
        condition: service_healthy
    
    volumes:
      - ./outputs:/app/outputs:ro
      - ./monitor_logs:/app/monitor_logs
    
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app/src:/app
      - CHECKPOINT_DIR=/app/outputs/oe3/checkpoints
      - TERM=xterm
    
    command: ["python", "scripts/monitor_checkpoints.py"]
    
    restart: unless-stopped
    
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"
        labels: "service=monitor"
    
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 8G
        reservations:
          cpus: '1'
          memory: 2G

  # Jupyter Lab for interactive analysis
  pvbesscar-jupyter:
    build:
      context: .
      dockerfile: Dockerfile
    image: pvbesscar:latest
    container_name: pvbesscar-jupyter
    hostname: pvbesscar-jupyter
    
    ports:
      - "8888:8888"
    
    volumes:
      - .:/workspace
      - ./outputs:/workspace/outputs
    
    environment:
      - JUPYTER_ENABLE_LAB=yes
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app/src:/app
    
    command: jupyter lab --ip=0.0.0.0 --allow-root --no-browser
    
    restart: unless-stopped
    
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 16G
        reservations:
          cpus: '2'
          memory: 8G

  # FastAPI API
  fastapi-app:
    build:
      context: .
      dockerfile: Dockerfile.fastapi
    image: fastapi-mongo-api
    container_name: fastapi-app
    hostname: fastapi-app
    ports:
      - "8000:8000"
    environment:
      - MONGODB_URL=mongodb://mongodb:27017
      - MONGODB_DB=pvbesscar
      - PYTHONUNBUFFERED=1
    volumes:
      - ./fastapi_websocket_server.py:/app/fastapi_websocket_server.py:ro
    depends_on:
      mongodb:
        condition: service_healthy
    command: ["python", "fastapi_websocket_server.py"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    restart: unless-stopped

  # MongoDB Database
  mongodb:
    image: mongo:7.0
    container_name: mongodb
    hostname: mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password
      MONGO_INITDB_DATABASE: pvbesscar
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Mongo Express UI
  mongo-admin:
    image: mongo-express:latest
    container_name: mongo-admin
    hostname: mongo-admin
    ports:
      - "8081:8081"
    environment:
      ME_CONFIG_MONGODB_URL: mongodb://admin:password@mongodb:27017/
      ME_CONFIG_MONGODB_ADMINUSERNAME: admin
      ME_CONFIG_MONGODB_ADMINPASSWORD: password
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: password
      ME_CONFIG_BASICAUTH: "true"
    depends_on:
      - mongodb
    restart: unless-stopped

volumes:
  pipeline_data:
  training_results:
  pipeline_cache:
  mongodb_data:
  mongodb_config:
