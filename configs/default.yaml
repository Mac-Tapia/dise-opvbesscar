oe1:
  grid_connection:
    available_capacity_kva: null
    continuity: sistema aislado termico (diesel)
    power_factor: 0.95
    co2_factor_kg_per_kwh: 0.4521
  site:
    access_notes: Acceso vial y seguridad verificados en visita de campo.
    area_estacionamiento_m2: 957.0
    area_per_moto_m2: 2.0
    area_per_mototaxi_m2: 4.0
    area_techada_m2: 14450.0
    coverage_required_pct: 0.65
    distance_to_substation_m: 60.0
    dwell_hours_min: 4.0
    name: BESS Mall Iquitos
    restrictions_notes: Sombras puntuales por equipos; sin arbolado alto.
    security_notes: Zona de estacionamiento con vigilancia.
    vehicles_peak_motos: 270
    vehicles_peak_mototaxis: 39
oe2:
  data:
    solar_file: data/oe2/Generacionsolar/pv_generation_hourly_citylearn_v2.csv
    chargers_file: data/oe2/chargers/chargers_ev_ano_2024_v3.csv
    bess_file: data/oe2/bess/bess_ano_2024.csv
    mall_file: data/interim/oe2/demandamallkwh/demandamallhorakwh.csv
    charger_stats_file: data/oe2/chargers/chargers_real_statistics.csv
  bess:
    # BESS v5.4 (2026-02-19) - Dual-purpose: EV + MALL discharge to peak
    autonomy_hours: 4.0
    c_rate: 0.235  # 400 kW / 1700 kWh = 0.235
    discharge_only_ev_hours: false  # v5.4: MALL discharge enabled
    discharge_only_no_solar: false  # v5.4: MALL discharge during day if excess
    dod: 0.80      # 80% Depth of Discharge (min SOC = 20%)
    efficiency_roundtrip: 0.95
    fixed_capacity_kwh: 1700.0  # v5.4: 1700 kWh nominal (1360 usable @ 20-100% SOC) âœ… UPDATED
    fixed_power_kw: 400.0       # v5.4: 400 kW carga/descarga symmetric
    load_scope: dual_ev_and_mall  # v5.4: EV + MALL priority
    min_soc_percent: 20.0       # v5.4: Hard constraint @ 22h closing
    pv_night_threshold_kwh: 0.1
    round_kwh: 100
    sizing_mode: open_hours
    surplus_target_kwh_day: 9630.4
  dispatch_rules:
    description:
      "Cubrir bloque pico (18-21h) con prioridades: FV\xE2\u2020\u2019\
      EV \xE2\u2020\u2019 FV\xE2\u2020\u2019BESS \xE2\u2020\u2019 BESS\xE2\u2020\u2019\
      EV(noche) \xE2\u2020\u2019 BESS\xE2\u2020\u2019MALL(saturada)"
    enabled: true
    priority_1_pv_to_ev:
      description: "FV directamente a EVs (m\xC3\xA1xima prioridad)"
      enabled: true
      ev_power_limit_kw: 150.0
      pv_threshold_kwh: 0.5
    priority_2_pv_to_bess:
      bess_power_max_kw: 400.0  # v5.5: 400 kW (actualizado de 342 kW)
      bess_soc_max_percent: 100.0  # v5.5: Allow 100% (hard constraint via simulation)
      bess_soc_target_percent: 85.0
      description: FV excedente a BESS (cargar reserva para pico)
      enabled: true
    priority_3_bess_to_ev:
      bess_power_max_kw: 400.0  # v5.5: 400 kW
      bess_soc_min_percent: 20.0  # v5.5: Hard minimum @ 22h
      description: BESS a EVs cuando cae el sol (noche)
      enabled: true
      pv_night_threshold_kwh: 0.1
    priority_4_bess_to_mall:
      bess_saturation_percent: 95.0
      description: "BESS saturada + MALL discharge (v5.5: +78.8% vs v5.2)"
      enabled: true  # v5.5: MALL discharge HABILITADO
      mall_power_max_kw: 500.0
    priority_5_grid_import:
      allowed: true
      cost_multiplier_peak: 2.0
      description: "Importar desde red si es necesario cubrir d\xC3\xA9ficit"
      enabled: true
    reward_bonuses:
      battery_charge_bonus_weight: 0.005
      direct_solar_bonus_weight: 0.01
      grid_import_penalty_weight: 0.0001
  ev_fleet:
    # ConfiguraciÃ³n de cargadores (DATOS REALES OE2 v5.5 - 2026-02-18)
    charger_power_kw: 7.4               # Modo 3 monofÃ¡sico 32A @ 230V por toma
    charger_power_kw_moto: 7.4          # 15 cargadores motos @ 7.4kW/toma
    charger_power_kw_mototaxi: 7.4      # 4 cargadores mototaxis @ 7.4kW/toma
    n_chargers: 19                      # Alias para total_chargers (sincronizado con cÃ³digo)
    total_chargers: 19                  # Total fÃ­sico: 15 + 4 = 19 cargadores
    total_sockets: 38                   # Total sockets: 19 Ã— 2 = 38 (30 motos + 8 mototaxis)
    # Demanda EV constante para tracking COâ‚‚ (worst-case estimate)
    ev_demand_constant_kw: 50.0         # EstimaciÃ³n: 280,632 kWh/aÃ±o / 8760h â‰ˆ 32 kW avg, 50 kW peak
    closing_hour: 22
    daily_sessions_factor: 1.0
    fc_motos: 0.55
    fc_mototaxis: 0.55
    motos_count: 270
    mototaxis_count: 39
    opening_hour: 9
    pe_motos: 0.30
    pe_mototaxis: 0.30
    peak_hours:
      - 18
      - 19
      - 20
      - 21
    peak_share_day: 0.5
    session_minutes: 30
    sockets_per_charger: 2              # 2 tomas por cargador (Modo 3)
    utilization: 0.92
  location:
    alt: 104.0
    lat: -3.75
    lon: -73.25
    tz: America/Lima
  mall:
    energy_kwh_day: 2400.0
    shape_24h: null
  operational_control:
    bess_soc_target:
      during_peak_hours: 0.4
      normal_hours: 0.6
      pre_peak_hours: 0.85
    fairness_penalty_weight: 0.15
    import_penalty_weight: 0.3
    peak_cost_multiplier: 1.5
    peak_hours:
      - 18
      - 19
      - 20
      - 21
    power_limits_kw:
      playa_motos: 120.0
      playa_mototaxis: 48.0
      total_aggregate: 150.0
    soc_reserve_penalty: 0.2
    valley_hours:
      - 9
      - 10
      - 11
      - 12
  solar:
    area_total_m2: 15200.0
    candidate_count: 5
    factor_diseno: 0.65
    inverter_name: Eaton__Xpert1670
    module_name: Kyocera_Solar_KS20__2008__E__
    scale_to_target_annual: true
    selection_metric: energy_per_m2
    selection_mode: auto_top5
    surface_azimuth: 0.0
    surface_tilt: 10.0
    target_ac_kw: 3118.5
    target_annual_kwh: 1217300
    target_dc_kw: 4050.0
    use_pvlib: true
oe3:
  baseline_episodes: 3
  city_baseline_tpy:
    electricity_generation: 290000.0
    transport: 258250.0
  
  # ===========================================================================
  # MÃ‰TRICAS DE REFERENCIA EPISODIO 1 VALIDADO (CityLearn v2 - 2026-02-07)
  # ===========================================================================
  reference_metrics:
    # Componentes de Reward (multiobjetivo) - VALIDADO
    reward_components:
      r_solar: -0.2478          # Autoconsumo solar (47.2%)
      r_cost: -0.2797           # Minimizar tarifa
      r_ev: 0.9998              # SatisfacciÃ³n carga EV (excelente)
      r_grid: -0.0196           # Estabilidad de red
      r_co2: 0.2496             # ReducciÃ³n CO2
    
    # CO2 - ReducciÃ³n Directa e Indirecta (kg/aÃ±o, v5.5)
    co2_annual:
      grid_emitted_kg: 197262         # CO2 desde importaciÃ³n grid baseline (50 kW Ã— 8760 Ã— 0.4521)
      avoided_indirect_kg: 550351     # Solar evita grid (1,217.3 MWh Ã— 0.4521 kg/kWh)
      avoided_direct_kg: 280437       # EVs cargados desde solar (38 sockets Ã— 352,887 kWh/anno conversion)
      avoided_total_kg: 830788        # ReducciÃ³n combinada total (550,351 + 280,437)
      net_kg: 830788                  # CO2 neto evitado vs baseline
      reduction_pct: 80.8             # Porcentaje reducciÃ³n vs baseline (830,788 / 1,027,650 â†’ 80.8%)
    
    # VehÃ­culos Cargados (datos reales del dataset v5.2)
    vehicles_charged:
      motos_vehicle_hours: 98550      # VehÃ­culo-horas motos/aÃ±o (270/dÃ­a Ã— 365)
      motos_per_day_avg: 270          # Promedio motos/dÃ­a (30 tomas)
      mototaxis_vehicle_hours: 14235  # VehÃ­culo-horas mototaxis/aÃ±o (39/dÃ­a Ã— 365)
      mototaxis_per_day_avg: 39       # Promedio mototaxis/dÃ­a (8 tomas)
      total_sockets: 38               # 30 motos + 8 mototaxis
    
    # Control y OperaciÃ³n - MÃ‰TRICAS VALIDADAS
    control_operation:
      sockets_active_pct: 50.0        # % sockets activos (de 38)
      bess_control_intensity: 0.517   # 51.7% intensidad de control BESS
      bess_soc_avg: 0.905             # 90.5% SOC promedio BESS
      ev_soc_avg: 1.000               # 100% SOC promedio EVs
      grid_ramp_kwh_per_h: 207.5      # kWh/h rampa de grid
      grid_stability_score: 0.8       # 1 - |rampa|/max_rampa
    
    # Ahorro de Costos (USD/aÃ±o) - VALIDADO
    cost_savings:
      cost_total_usd: 917705          # Costo total operaciÃ³n
      savings_vs_baseline: 1658503    # Ahorro vs baseline sin solar
      # ========== TARIFAS OSINERGMIN IQUITOS 2025 (REFERENCIAL) ==========
      # Tarifa integrada para carga de motos y mototaxis
      tariff_generation_solar_usd_per_kwh: 0.10   # GeneraciÃ³n solar (CAPEX + O&M bajo)
      tariff_bess_storage_usd_per_kwh: 0.06      # Almacenamiento BESS (CAPEX baterÃ­a + O&M)
      tariff_ev_charge_distribution_usd_per_kwh: 0.12  # DistribuciÃ³n EV (red, transf, pÃ©rdidas)
      tariff_usd_per_kwh: 0.28        # Tarifa integral OSINERGMIN (solar + BESS + distr)

  rewards:
    # Multi-Objective Reward Weights (must sum to 1.0) - VALIDATED v5.5 2026-02-18
    co2_weight: 0.50              # PRIMARY: Reduce CO2 (grid import minimization) - v5.5 priority
    solar_weight: 0.20            # SECONDARY: Maximize solar self-consumption
    ev_satisfaction_weight: 0.15  # TERTIARY: EV charging satisfaction
    grid_stability_weight: 0.10   # QUATERNARY: Grid peak minimization
    cost_weight: 0.05             # QUINARY: Minimize electricity cost
    # NOTE: Weights validated for v5.5 system 2026-02-18. Total weight = 1.00 exactly.
    # Dispatch hierarchy penalties + aggressive SOC modulation already enforce EVs maximization.
    # CO2 Factors
    co2_grid_factor_kg_per_kwh: 0.4521  # Iquitos grid (indirecto, central tÃ©rmica aislada)
    ev_co2_conversion_kg_per_kwh: 2.146  # EV demand tracking conversion factor
  co2_emissions:
    annual_co2_budget_kg: 7000000
    bess_calendar_aging_kg_per_day: 0.01
    bess_charging_efficiency: 0.95
    bess_cycling_co2_per_cycle: 0.05
    bess_discharging_efficiency: 0.95
    bess_standby_loss_percent_day: 0.1
    diesel_backup_factor_kg_kwh: 0.2667
    grid_import_factor_kg_kwh: 0.4521  # Factor de emisiÃ³n grid Iquitos (central tÃ©rmica aislada)
    #    - ev_co2_conversion_kg_per_kwh: 2.146 (equivalente combustiÃ³n)
    #    - Demanda: 50.0 kW constante
    #    - Acumulado/hora: 50 Ã— 2.146 = 107.3 kg COâ‚‚/h
    #    - Anual (baseline): 50 Ã— 2.146 Ã— 8760 = 938,460 kg COâ‚‚/aÃ±o
    #    - NO SE REDUCE (es la demanda fija)
    #    - PropÃ³sito: Referencia de lÃ­nea base
    #
    # 2. COâ‚‚ INDIRECTO (Grid Import - OBJETIVO PRINCIPAL):
    #    - co2_grid_factor_kg_per_kwh: 0.4521 (central tÃ©rmica aislada)
    #    - ReducciÃ³n indirecta = Solar PV directo Ã— 0.4521
    #    - Ejemplo: 1000 kWh PV directo â†’ 1000 Ã— 0.4521 = 452.1 kg COâ‚‚ evitado
    #    - SE REDUCE por: Maximizar PV directo a EVs
    #    - PropÃ³sito: Objetivo de optimizaciÃ³n principal (peso: 0.50)
    #
    # 3. ARQUITECTURA DE REDUCCIONES:
    #    Baseline: Grid import = 50 kW Ã— 8760 h Ã— 0.4521 = 197,262 kg COâ‚‚/aÃ±o (indirecto)
    #    Con RL:   Grid import reducido = (50 - solar_directo) Ã— 8760 Ã— 0.4521
    #    ReducciÃ³n neta = solar_directo_anual Ã— 0.4521 (kg COâ‚‚ evitado)
    #
    # 4. SINCRONIZACIÃ“N EN SISTEMA:
    #    - dataset_builder.py: L443-456 - Valida y carga valores
    #    - rewards.py: Calcula reward basado en reducciones indirectas
    #    - agents (SAC/PPO/A2C): Optimizan para maximizar PV directo
    #    - simulate.py: Reporta ambas reducciones (directa + indirecta)
    #
    co2_grid_factor_kg_per_kwh: 0.4521        # Grid COâ‚‚ factor [INDIRECTO]
    ev_co2_conversion_kg_per_kwh: 2.146       # Demanda EV COâ‚‚ [DIRECTO - tracking]
    ev_demand_constant_kw: 50.0               # Demanda EV constante [DIRECTO - fijo]
    # TRACKING COâ‚‚ DIRECTO (workaround CityLearn 2.5.0):
    # - ev_demand_kw = 50 kW constante (definido en agentes SAC/PPO/A2C)
    # - co2_direct_kg = 50 kW Ã— 2.146 kg/kWh = 107.3 kg/h acumulativo
    # - motos_activas = (50 Ã— 0.80) / 2 = 20 motos/h
    # - mototaxis_activas = (50 Ã— 0.20) / 3 = 3 mototaxis/h
    reduction_strategies:
      bess_efficiency_optimization:
        description: Optimizar ciclos y conversiones BESS
        enabled: true
        max_cycles_per_year: 200
        weight: 0.15
      cost_reduction:
        description: Minimizar costo operativo (colateral)
        enabled: true
        weight: 0.05
      direct_solar_maximization:
        co2_avoided_per_kwh: 0.4521
        description: Maximizar FV directo a EVs (P1 despacho)
        enabled: true
        weight: 0.5
      grid_import_minimization:
        description: "Minimizar importaci\xC3\xB3n desde grid"
        enabled: true
        penalty_multiplier_peak_hours: 2.0
        weight: 0.3
  dataset:
    central_agent: true
    name: iquitos_ev_mall
    template_name: citylearn_challenge_2022_phase_all_plus_evs
  emissions:
    # COâ‚‚ evitado por vehÃ­culos elÃ©ctricos vs combustiÃ³n
    kgco2_per_gallon: 8.9      # kg COâ‚‚ por galÃ³n de gasolina (combustiÃ³n)
    km_per_gallon: 120.0        # Eficiencia motos/mototaxis a combustiÃ³n (km/galÃ³n)
    km_per_kwh: 35.0            # Eficiencia motos/mototaxis elÃ©ctricos (km/kWh)
    project_life_years: 20
  evaluation:
    a2c:
      batch_size: 146 # âœ“ FIXED: 64â†’146 (perfect divisor: 8760/146=60 mini-batches, no truncation)
      checkpoint_freq_steps: 200
      device: cuda # âœ… FIXED: cpuâ†’cuda (usar GPU para entrenamiento real)
      entropy_coef: 0.001
      episodes: 10  # 10 episodios = 87,600 timesteps
      gamma: 0.99 # Paper standard
      gae_lambda: 0.95 # Paper: GAE
      learning_rate: 0.0001 # 1e-4 (can match PPO, on-policy simple)
      learning_rate_schedule: linear
      log_interval: 100
      max_grad_norm: 0.5
      n_steps: 128 # 128 (vs Paper variable), short rollouts
      normalize_advantage: true # Paper standard
      normalize_observations: true
      normalize_rewards: true
      reward_scale: 0.1
      hidden_sizes: [128, 128]
      use_rms_prop: true # Paper: RMSProp is standard for A3C/A2C
      progress_interval_episodes: 1
      save_final: true
      # NOTA: Pesos multiobjetivo se configuran en rewards.py via multi_objective_priority
    agents:
      - SAC
      - PPO
      - A2C
    co2_tracking: true
    multi_objective_priority: co2_focus  # PRIMARY: Grid COâ‚‚ minimization (weight 0.35)
    ppo:
      batch_size: 120 # âœ“ FIXED: 256â†’120 (perfect divisor: 8760/120=73 mini-batches, no truncation)
      checkpoint_freq_steps: 500
      device: cuda
      episodes: 10  # 10 episodios = 87,600 timesteps
      ent_coef: 0.01 # â†‘ OPTIMIZED: 0.001â†’0.01 (exploration incentive)
      gamma: 0.99 # Paper standard
      gae_lambda: 0.98 # â†‘ OPTIMIZED: 0.95â†’0.98 (better long-term advantages)
      kl_adaptive: true # â†‘ OPTIMIZED: Enable adaptive KL divergence
      target_kl: 0.02 # â†‘ OPTIMIZED: NEW - Early stopping for KL divergence
      learning_rate: 1e-4 # 1e-4 (3x smaller than before, more stable)
      learning_rate_schedule: linear
      log_interval: 100
      max_grad_norm: 1.0 # â†‘ OPTIMIZED: 0.5â†’1.0 (gradient clipping)
      clip_range: 0.5 # â†‘ OPTIMIZED: 0.2â†’0.5 (2.5x more flexible)
      clip_range_vf: 0.5 # â†‘ OPTIMIZED: NEW - Value function clipping
      n_epochs: 10 # â†‘ OPTIMIZED: 2â†’10 (more training passes)
      n_steps: 2048 # âœ… FIXED: 8760â†’2048 (proper rollout size, ~4 updates/episode)
      normalize_advantage: true # âœ… Normalize advantages by batch
      use_sde: true # â†‘ OPTIMIZED: NEW - State-Dependent Exploration
      sde_sample_freq: -1 # Resample every step
      normalize_observations: true
      normalize_rewards: true
      reward_scale: 0.5 # AJUSTE: 0.1â†’0.5 (evita explosiÃ³n critic_loss)
      clip_reward: 1.0 # âœ… CRITICAL: Clip rewards to [-1, 1]
      clip_obs: 5.0 # â†‘ OPTIMIZED: Aggressive obs clipping
      hidden_sizes: [256, 256] # â†‘ OPTIMIZED: 64â†’256 (more capacity)
      # NOTA: Pesos multiobjetivo se configuran en rewards.py via multi_objective_priority
      prefer_citylearn: false
      progress_interval_episodes: 1
      save_final: true
      resume_checkpoints: false
      reward_smooth_lambda: 0.15
    resume_checkpoints: true
    reward_components:
      base_weight: 0.8
      co2_direct_weight: 0.12
      co2_indirect_weight: 0.08
    sac:
      batch_size: 256 # âœ… FIX: 512â†’256 (evita OOM en RTX 4060, coincide con SACConfig)
      buffer_size: 200000 # âœ… FIX: 50kâ†’200k (captura variaciÃ³n anual completa, coincide con SACConfig)
      checkpoint_freq_steps: 500
      deterministic_eval: true
      device: cuda
      episodes: 3  # Test rÃ¡pido
      ent_coef: auto # âœ… Auto-tuning entropy (adaptive exploration)
      ent_coef_init: 0.5 # âœ… FIX: 0.2â†’0.5 (mÃ¡s exploraciÃ³n para descubrir polÃ­tica solar, coincide con SACConfig)
      ent_coef_lr: 1e-3 # âœ… FIX: 3e-5â†’1e-3 (adaptaciÃ³n 33Ã— mÃ¡s rÃ¡pida, coincide con SACConfig)
      gamma: 0.995 # â†‘ OPTIMIZED: 0.99â†’0.995 (mayor horizonte temporal)
      tau: 0.02 # â†‘ OPTIMIZED: 0.01â†’0.02 (target network actualiza mÃ¡s rÃ¡pido)
      gradient_steps: 1 # âœ… FIX: 8â†’1 (coincide con SACConfig, SAC es off-policy con 1 update por sample)
      learning_rate: 5e-5 # âœ… FIX: 1e-4â†’5e-5 (reduce inestabilidad gradient, coincide con SACConfig)
      learning_starts: 2000 # â†“ OPTIMIZED: 5000â†’2000 (empezar antes a aprender)
      log_interval: 100
      max_grad_norm: 10.0 # âœ… SINCRONIZADO: 0.5â†’10.0 (SAC off-policy necesita gradientes mÃ¡s grandes)
      reward_scale: 0.5 # AJUSTE: 0.1â†’0.5 (evita explosiÃ³n critic_loss)
      hidden_sizes: [256, 256] # ðŸ”´ FIX: 512â†’256 (prevent overfitting)
      use_prioritized_replay: false # ðŸ”´ CRITICAL FIX: Disable PER (causing instability)
      per_alpha: 0.6 # â†‘ OPTIMIZED: Prioritization exponent
      per_beta: 0.4 # â†‘ OPTIMIZED: Importance sampling
      per_epsilon: 1e-6 # â†‘ OPTIMIZED: Min priority epsilon
      normalize_observations: true
      normalize_rewards: true
      clip_reward: 1.0 # âœ… CRITICAL: Clip rewards to [-1, 1]
      clip_obs: 100.0 # âœ… SINCRONIZADO: 5.0â†’100.0 (evita destruir data post-normalizaciÃ³n)
      # NOTA: Pesos multiobjetivo se configuran en rewards.py via multi_objective_priority
      prefer_citylearn: false
      progress_interval_episodes: 1
      save_final: true
      train_freq: 1 # â†‘ OPTIMIZED: 2â†’1 (entrenar cada step)
      use_amp: true
      use_sde: true # â†‘ OPTIMIZED: falseâ†’true (mejor exploraciÃ³n)
  grid:
    carbon_intensity_kg_per_kwh: 0.4521
    tariff_usd_per_kwh: 0.2
paths:
  analyses_dir: analyses
  interim_dir: data/interim
  outputs_dir: outputs
  processed_dir: data/processed
  raw_dir: data/raw
  reports_dir: reports
project:
  seconds_per_time_step: 3600
  seed: 42
  year: 2024
