================================================================================
ENTRENAR SAC - CON MULTIOBJETIVO REAL (CO2, SOLAR, COST, EV, GRID)
================================================================================
Inicio: 2026-02-14 21:48:33

[GPU] NVIDIA GeForce RTX 4060 Laptop GPU
   VRAM: 8.6 GB
   CUDA: 12.1
   Entrenamiento SAC en GPU (actor-critic 512x512, replay buffer 2M - OPCION A Aggressive)
   Device: CUDA


[INFO] Checkpoints SAC existentes seran PRESERVADOS (continuar entrenamiento)
       Para entrenar desde cero, descomentar clean_sac_checkpoints_safe() en main()

  Dataset precompilado: data\processed\citylearn\iquitos_ev_mall
  OK Dataset: data\processed\citylearn\iquitos_ev_mall

[3] CARGAR DATOS DEL DATASET CITYLEARN V2 CONSTRUIDO (8760 horas = 1 ano)
--------------------------------------------------------------------------------
  [SOLAR] [OK] REAL: col=ac_power_kw | 8292514 kWh/year (8760h)
  [SOLAR] Columnas cargadas: ['ghi_wm2', 'dni_wm2', 'dhi_wm2', 'temp_air_c', 'wind_speed_ms', 'dc_power_kw', 'ac_power_kw', 'dc_energy_kwh', 'ac_energy_kwh']
  [SOLAR]   GHI: max=1000 W/m2, sum=1,668,084
  [SOLAR]   Temp: min=20.7C, max=33.2C
  [CHARGERS] [OK] REAL: Loading from chargers_ev_ano_2024_v3.csv
  [CHARGERS] [OK] REAL: 38 sockets total (ESPECIFICACION OE2: 38)
  [CHARGERS]   MOTOS:     30 sockets | 1,944,720 kWh/ano | 222.0 kW avg
  [CHARGERS]   MOTOTAXIS: 8 sockets | 518,592 kWh/ano | 59.2 kW avg
  [CHARGERS]   TOTAL:     2,463,312 kWh/ano | 281.2 kW avg
  [MALL] [OK] REAL: 12368653 kWh/year (avg 1411.9 kW/h)
  [BESS] [!] SIMULATED - Loading from: bess_ano_2024.csv (OE2 REAL)
  [BESS] Simulated avg SOC: 55.2%
  [BESS] Costos grid:         2,300,787.00 soles/ano
  [BESS] Ahorros pico:        182,247.53 soles/ano
  [BESS] CO2 evitado indirecto: 279,679 kg/ano
  [BESS] Solar->EV:            179,587 kWh/ano
  [BESS] BESS->EV:             143,740 kWh/ano
  [BESS] Grid import total:   6,485,565 kWh/ano
  [CHARGER STATS] Cargada desde: chargers_real_statistics.csv
  [BESS] EV Demand (REAL):    412,236 kWh/ano
  [BESS] Mall Demand (REAL):  12,368,653 kWh/ano
  [BESS] PV Gen (REAL):       8,292,514 kWh/ano

[LOAD] Extrayendo TODAS las variables observables del dataset_builder v5.5...
[LOAD] Cargando variables observables...
[LOAD] Observables: usando fallback (None - datos reales en observacion directa)

  [OK] Validacion de dimensiones OK (8760 horas x 4 datasets)
[3.5] VALIDAR CALIDAD DE DATOS
--------------------------------------------------------------------------------
  [OK] Solar: OK (sin NaN/inf)
  [OK] Chargers: OK (sin NaN/inf)
  [OK] Mall: OK (sin NaN/inf)
  [OK] BESS SOC: OK (sin NaN/inf)
  [OK] BESS Costs: OK (sin NaN/inf)
  [OK] Charger Max Power: OK (sin NaN/inf)
  [OK] Charger Mean Power: OK (sin NaN/inf)

[4] CONFIGURAR AGENTE SAC CON DATOS 100% REALES
--------------------------------------------------------------------------------
  === SOLAR (PVGIS + PVLib) ===
  Solar AC Power:  cargado [OK] (8760 horas, 8,292,514 kWh/ano)
  Solar Columnas:  9 columnas REALES: ['ghi_wm2', 'dni_wm2', 'dhi_wm2', 'temp_air_c', 'wind_speed_ms', 'dc_power_kw', 'ac_power_kw', 'dc_energy_kwh', 'ac_energy_kwh']

  === CHARGERS (MEDICIONES) ===
  MOTOS:           30 sockets | 1,944,720 kWh/ano
  MOTOTAXIS:       8 sockets | 518,592 kWh/ano
  TOTAL:           38 sockets | 2,463,312 kWh/ano

  === MALL (MEDICIONES) ===
  Mall demand:     cargado [OK] (12,368,653 kWh/ano)

  === BESS (SIMULACION CON DATOS REALES) ===
  BESS SOC:        cargado [OK] (avg: 55.2%)
  BESS Costos:     cargado [OK] (2,300,787 soles/ano)
  BESS Peak Svngs: cargado [OK] (182,248 soles/ano)
  Tarifa OSINERG:  cargado [OK] (mean: 0.3083 sol/kWh)
  CO2 Evitado:     cargado [OK] (279,679 kg/ano)
  Energy Flows:    cargado [OK] (12 flujos)

  === DEMANDAS REALES (DATASET BESS) ===
  EV Demand REAL:  412,236 kWh/ano
  Mall Dem REAL:   12,368,653 kWh/ano
  PV Gen REAL:     8,292,514 kWh/ano

  Learning rate:        <function SACConfig.adaptive_lr_schedule.<locals>.schedule at 0x000001610AD2F880>
  Buffer size:          300,000
  Batch size:           64
  Tau (soft update):    0.002
  Entropy coef:         auto
  Network:              Actor/Critic [256, 256]

[5] CONFIGURAR MULTIOBJETIVO (CO2, SOLAR, COST, EV, GRID)
--------------------------------------------------------------------------------
  OK Reward weights loaded (co2_focus):
     - CO2 grid:         0.350
     - Solar:            0.200
     - EV satisfaction:  0.300
     - Cost:             0.100
     - Grid stability:   0.050

[6] CREAR AMBIENTE REAL CON DATOS OE2 (CON REWARD WEIGHTS)
--------------------------------------------------------------------------------
  [OK] Ambiente REAL creado con datos OE2 100% REALES:
     - Observation space: 246 dims (v6.0: 156 base + 90 new features = bidirectional communication)
     - Action space:      39 dims (BESS + 38 sockets)
     - Solar data:        9 columnas REALES (GHI, DNI, temp, etc.)
     - MOTOS:             30 sockets (30 max)
     - MOTOTAXIS:         8 sockets (8 max)
     - Energy flows:      12 flujos REALES
     - Observable vars: 27 columnas del dataset_builder (todas las reales)
     - EV Demand REAL:    SI
     - Mall Demand REAL:  SI
     - COMUNICACION:      BESS<->Solar<->EV<->Cargadores<->Motos<->Mototaxis + Dataset_Builder
  Observation space: 246 (v6.0: 156 base + 38 per-socket SOC + 38 time remaining + 14 signals)
  Action space:      39 (1 BESS + 38 chargers)
  Datos cargados:
    - Solar:     8760 horas
    - Chargers:  38 sockets

[7] INICIALIZAR AGENTE SAC
--------------------------------------------------------------------------------
  Checkpoint valido encontrado: sac_model_8760_steps.zip
  Cargando SAC desde checkpoint: sac_model_8760_steps.zip
Wrapping the env with a `Monitor` wrapper
Wrapping the env in a DummyVecEnv.
  Device: cuda

[8] ENTRENAMIENTO SAC - 15 EPISODIOS COMPLETOS (OPTIMIZADO)
--------------------------------------------------------------------------------
  Total timesteps: 131,400 (15 episodios x 8,760 h/episodio)
  Checkpoint cada: 1,000 steps
  Warmup steps:    5,000 (random exploration)
  Batch size:      64
  Buffer size:     300,000
  tau:             0.002
  gamma:           0.98
  Train freq:      (4, 'step')
  Gradient steps:  2 (updates per env step)
  Entropy coef:    auto
  Target entropy:  -19.5
  Learning rate:   <function SACConfig.adaptive_lr_schedule.<locals>.schedule at 0x000001610AD2F880>
  Networks:        Actor/Critic [256, 256]
  Datos: Datos reales OE2 (solar 8.29GWh + chargers + mall 12.37GWh + BESS 940kWh)
  Device: CUDA

  METRICAS LOGUEADAS (cada 500 steps):
  - Actor loss, Critic loss (Q1/Q2)
  - Mean Q-value (alerta si > 1000)
  - Entropy y alpha (alerta si entropy < 0.1 o alpha < 0.01)
  - Replay buffer fill %
  - Updates per step (ratio real)
  - Mean/Std acciones, log_std
  EVAL (cada 8760 steps = 1 episodio):
  - Eval Return (deterministico, sin ruido)

  Progreso por episodio (cada 100 timesteps dentro del episodio):
--------------------------------------------------------------------------------

[PARAMETROS MULTIOBJETIVO - PESOS DE RECOMPENSA]
--------------------------------------------------------------------------------
  [OK] Reward weights cargados (priority=co2_focus):
    - CO2 Grid Minimization:    0.350
    - Solar Self-Consumption:  0.200
    - EV Satisfaction:         0.300
    - Cost Minimization:       0.100
    - Grid Stability:          0.050
  [OK] Total weight sum:          1.000


[INTENTO 1/3] Iniciando entrenamiento SAC...
Logging to outputs\sac_training\tensorboard\SAC_0
