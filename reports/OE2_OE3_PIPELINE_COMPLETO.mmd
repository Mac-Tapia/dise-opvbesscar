graph TB
    subgraph OE2["ğŸ“¦ FASE OE2: DIMENSIONAMIENTO (Infraestructura)"]
        PV["â˜€ï¸ Paneles Solares<br/>4,050 kWp<br/>PVGIS 8,760h"]
        BESS["ğŸ”‹ BaterÃ­a<br/>2,000 kWh / 400 kW<br/>6 Fases OperaciÃ³n"]
        CHG["ğŸ”Œ Cargadores<br/>19 chargers Ã— 2 sockets<br/>38 puntos de carga<br/>7.4 kW Mode 3"]
        MALL["ğŸ¢ Demanda Mall<br/>100 kW 24h<br/>Base load"]
        EV["ğŸš— VehÃ­culos<br/>270 motos + 39 mototaxis<br/>309 dÃ­a"]
        
        PV -->|pv_generation.csv| Data1["ğŸ“Š CSV Datos OE2<br/>data/oe2/"]
        BESS -->|BESS specs| Data1
        CHG -->|Charger config| Data1
        MALL -->|Demand profile| Data1
        EV -->|EV arrival queue| Data1
    end
    
    subgraph Pipeline["ğŸ”„ VALIDACIÃ“N & CARGA DE DATOS"]
        Data1 -->|Load & Validate| Loader["data_loader.py<br/>Valida 8,760 filas<br/>No 15-min âš ï¸"]
        Loader -->|Sync OE2â†”OE3| Builder["dataset_builder.py<br/>Crea 394-dim obs<br/>Reward weights"]
    end
    
    subgraph CityLearn["ğŸŒ ENTORNO CITYLEARN v2"]
        Env["CityLearn Environment<br/>Timestep: 1 hora = 3,600 seg<br/>Episodes: 8,760 steps = 1 aÃ±o"]
        ObsSpace["ğŸ“‹ Observation Space<br/>- Solar W/mÂ²<br/>- BESS SOC %<br/>- 38 socket states<br/>- Time features (hour/month/dow)<br/>Total: 394 dimensions"]
        ActSpace["ğŸ® Action Space<br/>Continuous [0,1]<br/>1 BESS + 38 sockets<br/>39 total actions"]
        
        Builder -->|Init env| Env
        Env -->|Provides| ObsSpace
        Env -->|Accepts| ActSpace
    end
    
    subgraph Training["ğŸ¤– ENTRENAMIENTO RL - 3 AGENTES"]
        SAC["ğŸ† SAC<br/>Off-Policy<br/>Soft Actor-Critic<br/>stable-baselines3"]
        PPO["ğŸ“ˆ PPO<br/>On-Policy<br/>Proximal Policy<br/>stable-baselines3"]
        A2C["âš¡ A2C<br/>On-Policy<br/>Actor-Critic<br/>stable-baselines3"]
        
        Reward["Reward Function<br/>w_CO2=0.35 (PRIMARY)<br/>w_EV=0.30 (SECONDARY)<br/>w_solar=0.20<br/>w_cost=0.10<br/>w_grid=0.05"]
        
        ObsSpace -->|87,600 steps| SAC
        ObsSpace -->|10 episodios| PPO
        ObsSpace -->|= 10 aÃ±os| A2C
        Reward -->|Guide policy| SAC
        Reward -->|Guide policy| PPO
        Reward -->|Guide policy| A2C
    end
    
    subgraph Checkpoints["ğŸ’¾ GUARDADO DE MODELOS"]
        SACC["checkpoints/SAC/<br/>sac_model_*.zip<br/>policy network<br/>value network<br/>optimizer state"]
        PPOC["checkpoints/PPO/<br/>ppo_model_*.zip"]
        A2CC["checkpoints/A2C/<br/>a2c_model_*.zip"]
        
        SAC -->|Save| SACC
        PPO -->|Save| PPOC
        A2C -->|Save| A2CC
    end
    
    subgraph Results["ğŸ“Š RESULTADOS Y METRICAS"]
        SACJ["outputs/sac_training/<br/>result_sac.json<br/>18,621 lineas<br/>validation metrics"]
        PPOJ["outputs/ppo_training/<br/>ppo_summary.json"]
        A2CJ["outputs/a2c_training/<br/>result_a2c.json"]
        
        SACC -->|Export metrics| SACJ
        PPOC -->|Export metrics| PPOJ
        A2CC -->|Export metrics| A2CJ
    end
    
    subgraph Validation["âœ… VALIDACIÃ“N DE RESULTADOS"]
        Val["Comparison vs Baseline<br/>- CO2 avoided kg/aÃ±o<br/>- Solar utilization %<br/>- Grid import kWh<br/>- EV satisfaction %<br/>- Training time sec"]
        
        SACJ -->|Parse| Val
        PPOJ -->|Parse| Val
        A2CJ -->|Parse| Val
    end
    
    subgraph Thesis["ğŸ“„ GENERACIÃ“N DOCUMENTO TESIS"]
        Report["generate_oe3_report.py<br/>Dynamic data extraction<br/>Real checkpoint values<br/>41 acÃ¡pites completos"]
        
        Val -->|Real data| Report
        Report -->|Generate| DocX["ğŸ“– OE3_INFORME_DETALLADO<br/>CON_DATOS_REALES.docx<br/>15-18 pÃ¡ginas<br/>8 tablas<br/>100% completitud<br/>âœ… THESIS READY"]
    end
    
    subgraph Tech["ğŸ› ï¸ STACK TECNOLÃ“GICO"]
        Python["Python 3.11+<br/>type hints enabled"]
        SB3["stable-baselines3 v2.0+<br/>SAC, PPO, A2C"]
        Gym["Gymnasium 0.27+<br/>Standard RL API"]
        Torch["PyTorch 2.0+ CUDA<br/>GPU: RTX 4060"]
        Data["pandas 2.0+<br/>numpy 1.25+"]
        YAML["PyYAML 6.0<br/>configs/"]
        DocX_lib["python-docx 0.8.11"]
        
        Python -->|Runtime| SB3
        Python -->|Runtime| Gym
        Python -->|Runtime| Torch
        Python -->|Runtime| Data
        YAML -->|Config| Report
        DocX_lib -->|Generate| DocX
    end
    
    style OE2 fill:#fff3cd
    style Pipeline fill:#d1ecf1
    style CityLearn fill:#d4edda
    style Training fill:#cce5ff
    style Checkpoints fill:#e7d4f5
    style Results fill:#f8d7da
    style Validation fill:#d1ecf1
    style Thesis fill:#c3e6cb
    style Tech fill:#f0f0f0