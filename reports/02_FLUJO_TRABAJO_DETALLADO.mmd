graph LR
    subgraph ETAPA1["ETAPA 1: Inputs del Proyecto"]
        MALLF["ğŸ“Š Demanda Mall<br/>demandamallhorakwh.csv<br/>PROMEDIO: 1,412 kW<br/>PICO: 2,763 kW"]
        SOLF["â˜€ï¸ GeneraciÃ³n Solar<br/>pv_generation_timeseries.csv<br/>4,050 kWp<br/>8,760 hourly"]
        EV_F["ğŸ›µ EV Demand Profiles<br/>demand_ev_anual.csv<br/>270 motos + 39 taxis<br/>38 sockets"]
        CFG["âš™ï¸ Configuration<br/>architecture.yaml<br/>500 timesteps"]
    end
    
    subgraph ETAPA2["ETAPA 2: Load & Validation"]
        DL["ğŸ“¥ Data Loader<br/>data_loader.py<br/>âœ“ Solar: 8,760 rows<br/>âœ“ Mall: 1,412 kW avg (2,763 peak)<br/>âœ“ EV: 38 sockets"]
        VAL["âœ… Validation<br/>OE2ValidationError<br/>if solar â‰  8,760h<br/>if chargers â‰  38"]
    end
    
    subgraph ETAPA3["ETAPA 3: Build OE2 Artifacts"]
        CHARGERS["ğŸ”Œ Charger Specs<br/>chargers.py<br/>19 units Ã— 2 sockets<br/>7.4 kW @ 230V"]
        BESS_CFG["ğŸ”‹ BESS Config<br/>bess.py<br/>2,000 kWh<br/>400 kW / SOC 20-100%"]
    end
    
    subgraph ETAPA4["ETAPA 4: Create CityLearn Environment"]
        CL["ğŸ—ï¸ CityLearn v2<br/>Environment<br/>- Obs: 394-dim solar/BESS/38sockets<br/>- Action: 39-dim (1 BESS + 38 chargers)<br/>- HorizonLen: 8,760 timesteps"]
    end
    
    subgraph ETAPA5["ETAPA 5: Reward & Agent Initialization"]
        RW["ğŸ¯ Multi-Objective Reward<br/>w_COâ‚‚=0.35 | w_EV=0.30<br/>w_solar=0.20 | w_cost=0.10<br/>w_grid=0.05"]
        AGENTS["ğŸ¤– Initialize Agents<br/>SAC/PPO/A2C from sb3<br/>policy='MlpPolicy'<br/>validate_env_spaces()"]
    end
    
    subgraph ETAPA6["ETAPA 6: Training Loop (26,280 steps)"]
        TRN["ğŸ”„ Learn with CB<br/>agent.learn(total_timesteps=26280)<br/>checkpoint every N steps<br/>save_config_every_callback"]
    end
    
    subgraph ETAPA7["ETAPA 7: Evaluation & Results"]
        EVAL["ğŸ“Š Evaluate<br/>COâ‚‚ (kg/aÃ±o)<br/>Solar self-consumption %<br/>Grid import (kWh)<br/>EV satisfaction %"]
        CSV["ğŸ’¾ Save Results<br/>result_{sac,ppo,a2c}.json<br/>ppo_training_summary.json"]
    end
    
    subgraph ETAPA8["ETAPA 8: Document + Report"]
        DOC["ğŸ“„ Generate Thesis<br/>generate_oe3_detailed_report.py<br/>Dynamic values from checkpoints<br/>41 acÃ¡pites (100% completud)"]
        PDF["ğŸ“• Save PDF Report<br/>OE3_INFORME_DETALLADO.pdf<br/>Reward weights validated<br/>MALL: 1,412 kW reflected"]
    end
    
    MALLF --> DL
    SOLF --> DL
    EV_F --> DL
    CFG --> DL
    
    DL --> VAL
    VAL --> CHARGERS
    VAL --> BESS_CFG
    CHARGERS --> CL
    BESS_CFG --> CL
    CL --> RW
    RW --> AGENTS
    AGENTS --> TRN
    TRN --> EVAL
    EVAL --> CSV
    CSV --> DOC
    DOC --> PDF
    
    style ETAPA1 fill:#fff3e0,stroke:#e65100,stroke-width:2px
    style ETAPA2 fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    style ETAPA3 fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    style ETAPA4 fill:#f1f8e9,stroke:#558b2f,stroke-width:2px
    style ETAPA5 fill:#ffe0b2,stroke:#ff6f00,stroke-width:2px
    style ETAPA6 fill:#e0f2f1,stroke:#00695c,stroke-width:2px
    style ETAPA7 fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    style ETAPA8 fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px