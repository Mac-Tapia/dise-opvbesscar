# VALIDACI√ìN R√ÅPIDA - Agents + OE2 Connection

## ‚úÖ CHECKLIST INMEDIATO

```python
# 1. Verificar que BESS SOC es visible (NO debe ser ~0)
# Ejecutar en terminal:
python -c "
import numpy as np
from src.iquitos_citylearn.oe3.agents.ppo_sb3 import PPOConfig

cfg = PPOConfig()
# Simular prescaling antiguo vs nuevo
prescale_old = np.ones(534) * 0.001
prescale_new = np.ones(534) * 0.001
prescale_new[-10:] = 1.0  # SOC dims

# BESS SOC simulation [0-1]
bess_soc_vals = np.array([0.25, 0.45, 0.60, 0.75])

# ANTES (invisible)
scaled_old = bess_soc_vals * 0.001
print(f'ANTES (BAD): BESS SOC {bess_soc_vals} ‚Üí {scaled_old}')

# DESPU√âS (visible)
scaled_new = bess_soc_vals * 1.0
print(f'DESPU√âS (GOOD): BESS SOC {bess_soc_vals} ‚Üí {scaled_new}')
"

# EXPECTED OUTPUT:
# ANTES (BAD): BESS SOC [0.25 0.45 0.6  0.75] ‚Üí [0.00025 0.00045 0.0006  0.00075]
# DESPU√âS (GOOD): BESS SOC [0.25 0.45 0.6  0.75] ‚Üí [0.25 0.45 0.6  0.75]
```

## ‚úÖ DATOS OE2 VALIDACI√ìN

```bash
# Verificar que archivos OE2 existen y son v√°lidos

# Solar
ls -lh data/interim/oe2/solar/pv_generation_timeseries.csv
# Expected: ~8.5MB (35,039 l√≠neas √ó 12 cols)

# Chargers
ls -lh data/interim/oe2/chargers/individual_chargers.json
# Expected: ~2.5MB (4,738 l√≠neas JSON)

# Perfil horario
wc -l data/interim/oe2/chargers/perfil_horario_carga.csv
# Expected: 25 l√≠neas (header + 24 horas + 1 extra)
```

## ‚úÖ AGENTES LISTOS

```bash
# Test: Importar agentes sin errores
python -c "
from src.iquitos_citylearn.oe3.agents import (
    PPOAgent, A2CAgent, SACAgent,
    PPOConfig, A2CConfig, SACConfig,
    detect_device
)
print('‚úÖ All agents import successfully')
print(f'‚úÖ Detected device: {detect_device()}')
"

# Expected: No errors, device detected
```

## ‚úÖ DATASET CITYLEARN

```bash
# Verificar dataset processed
ls -lh data/processed/citylearnv2_dataset/schema*.json
# Expected: ~149 KB schema file

# Verificar que tiene observables correctos
python -c "
import json
with open('data/processed/citylearnv2_dataset/schema.json') as f:
    schema = json.load(f)
    buildings = schema.get('buildings', [])
    print(f'‚úÖ Buildings in schema: {len(buildings)}')
    for b in buildings:
        obs_count = len(b.get('observables', []))
        actions = len(b.get('controllable_parameters', []))
        print(f'  - {b[\"name\"]}: {obs_count} observables, {actions} actions')
"

# Expected: 2 buildings, ~534 observables total, 126-128 actions
```

## ‚úÖ ENTRENAMIENTO QUICK TEST (5 min)

```bash
# Test r√°pido: 1 episode, 1 hour
python scripts/train_quick.py --device cuda --episodes 1 --max_hours 1

# EXPECTED LOGS (buscar estas l√≠neas):
# ‚úÖ "[PPO] GPU CUDA detectada..."
# ‚úÖ "[PPO] CityLearn dataset loaded: 8760 timesteps"
# ‚úÖ "[PPO] obs shape: (534,), action shape: (126,)"
# ‚úÖ "[PPO] BESS SOC in obs: mean=0.45, std=0.15" ‚Üê BESS VISIBLE
# ‚úÖ "[PPO] Episode 1 reward: ..."
```

## üî¥ SI ALGO FALLA

### Issue: "BESS SOC ~0 en observaciones"
```
FIX: Ya implementado en l√≠neas:
- ppo_sb3.py: ~249
- a2c_sb3.py: ~151
- sac.py: ~493

Verificar que prescale_new[-10:] = 1.0 est√° presente
```

### Issue: "Import error en agents"
```
FIX: Todos los imports est√°n centralizados en __init__.py
Verificar que tienes todas las dependencias:
pip install stable-baselines3 gymnasium citylearn

Ver: src/iquitos_citylearn/oe3/agents/__init__.py
```

### Issue: "Dataset no encontrado"
```
FIX: Ejecutar primero dataset builder
python -m scripts.run_oe3_build_dataset --config configs/default.yaml

Verificar: data/processed/citylearnv2_dataset/
```

## üìä RESUMEN ESTADO

| Componente | Status | Ready |
|-----------|--------|-------|
| **OE2 Data** | ‚úÖ Solar, Chargers, BESS | YES |
| **BESS Fix** | ‚úÖ Prescaling selectivo | YES |
| **Agents Code** | ‚úÖ Limpio, type-safe | YES |
| **Logging** | ‚úÖ Lazy formatting | YES |
| **Exceptions** | ‚úÖ Espec√≠ficos | YES |
| **CityLearn Dataset** | ‚úÖ 534 obs, 126 acts | YES |

**ESTADO FINAL: üü¢ LISTO PARA ENTRENAMIENTO**

---

## COMANDO FINAL

```bash
# Entrenamiento completo con todos los agentes
python scripts/train_agents_serial.py --device cuda --episodes 50

# Monitorear en tiempo real
python scripts/monitor_training_live_2026.py

# Generar resultados
python -m scripts.run_oe3_co2_table --config configs/default.yaml

# Ver comparaci√≥n baseline vs RL
cat COMPARACION_BASELINE_VS_RL.txt
```

---

**Si todo checks out: ‚úÖ READY TO TRAIN!**

