"""
CORRECCI√ìN DEFINITIVA: Garantizar exclusividad usando bandera bess_action_assigned
"""

# Usar una lista para rastrear cu√°ndo el BESS ha actuado en cada hora
# bess_action_assigned[h] = True si ya hemos asignado CARGA o DESCARGA en esta hora
# bess_action_assigned[h] = False si a√∫n se puede asignar UNA acci√≥n

# MODIFICACI√ìN A INSERTAR en simulate_bess_ev_exclusive, l√≠nea ~895:

"""
# Inicializar banderas de rastreo
bess_action_assigned = np.zeros(n_hours, dtype=bool)  # True si ya se asign√≥ carga O descarga
"""

# Luego, EN FASE 2 (despu√©s de asignar bess_charge):
"""
if max_charge > 0:
    bess_charge[h] = max_charge
    bess_action_assigned[h] = True  # MARCAR que se ejecut√≥ UNA acci√≥n
    ...
"""

# En FASE 4 (cambiar la condici√≥n):
"""
if (pv_h < mall_h and mall_h > PEAK_SHAVING_THRESHOLD_KW and 
    current_soc > soc_min and hour_of_day < closing_hour and 
    NOT bess_action_assigned[h]):  # SOLO si no ha habido acci√≥n a√∫n
"""

# En FASE 5 (igual que FASE 4):
"""
elif (ev_deficit > 0 and current_soc > soc_min and 
      hour_of_day < closing_hour and 
      NOT bess_action_assigned[h]):  # SOLO si no ha habido acci√≥n a√∫n
"""

print("=" * 100)
print("ESTRATEGIA DE CORRECCI√ìN: BANDERA bess_action_assigned")
print("=" * 100)
print("""
‚ö†Ô∏è PROBLEMA IDENTIFICADO:
- FASE 2 y FASE 4/5 pueden ejecutarse en la MISMA HORA
- Resultado: bess_charge > 0 Y bess_discharge > 0 simult√°neamente
- Las validaciones `bess_discharge[h] == 0` no solucionan porque la asignaci√≥n ocurre DENTRO del bloque

‚úÖ SOLUCI√ìN: Bandera bess_action_assigned[h]
- Inicializar como False para cada hora
- Cuando FASE 2 asigna bess_charge: SET bess_action_assigned[h] = True
- Cuando FASE 4/5 quieren ejecutar: VERIFICAR NOT bess_action_assigned[h]
- Esto garantiza que SOLO UNA acci√≥n (carga O descarga) por hora

üìã CAMBIOS REQUERIDOS:
1. L√≠nea ~895: Inicializar bess_action_assigned = np.zeros(n_hours, dtype=bool)
2. FASE 1/2: Agregar bess_action_assigned[h] = True cuando se asigna bess_charge[h]
3. FASE 4: Cambiar `if` a validar `NOT bess_action_assigned[h]`
4. FASE 5: Cambiar `elif` a validar `NOT bess_action_assigned[h]`
5. FASE 6: ASEGURAR que reinicia bess_action_assigned[h] = False (en reposo)
""")
