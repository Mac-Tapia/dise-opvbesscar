# INSTRUCCIONES PASO A PASO - EJECUTAR PPO EN CPU

## PASO 1: EDITAR CONFIGURACIÓN

### Opción A: Editar manualmente en VS Code
1. Abrir VS Code
2. Archivo → Open File → `configs/default.yaml`
3. Buscar la sección `oe3:`
4. Encontrar subsección `evaluation:` → `ppo:`
5. Hacer **EXACTAMENTE** estos 5 cambios:

### Cambios Exactos

**BUSCAR ESTO:**
```yaml
oe3:
  evaluation:
    ppo:
      device: auto             # ← CAMBIAR ESTO
      use_amp: true            # ← CAMBIAR ESTO
      timesteps: 87600         # ← CAMBIAR ESTO (o lo que sea)
      batch_size: 128          # ← CAMBIAR ESTO
      n_steps: 1024            # ← CAMBIAR ESTO
```

**REEMPLAZAR CON:**
```yaml
oe3:
  evaluation:
    ppo:
      device: cpu              # ← NUEVO
      use_amp: false           # ← NUEVO
      timesteps: 40000         # ← NUEVO (para test rápido)
      batch_size: 64           # ← NUEVO
      n_steps: 512             # ← NUEVO
```

### Opción B: Crear script para hacer el cambio automáticamente
```bash
# En PowerShell:
cd d:\diseñopvbesscar
python -c "
import yaml

with open('configs/default.yaml') as f:
    cfg = yaml.safe_load(f)

cfg['oe3']['evaluation']['ppo']['device'] = 'cpu'
cfg['oe3']['evaluation']['ppo']['use_amp'] = False
cfg['oe3']['evaluation']['ppo']['timesteps'] = 40000
cfg['oe3']['evaluation']['ppo']['batch_size'] = 64
cfg['oe3']['evaluation']['ppo']['n_steps'] = 512

with open('configs/default.yaml', 'w') as f:
    yaml.dump(cfg, f)

print('Config actualizado exitosamente')
"
```

---

## PASO 2: EJECUTAR PPO EN CPU

### Comando
```bash
cd d:\diseñopvbesscar
.venv\Scripts\python.exe -m scripts.run_oe3_simulate --config configs/default.yaml
```

### Qué esperar
- Primera línea: "INFO:iquitos_citylearn..."
- Progreso: Verás logs cada 1000 timesteps
- Sin errores GPU
- Checkpoints guardados cada 500 pasos

### Tiempo estimado
- 40,000 pasos: 10-15 minutos
- Si completa exitosamente, pasará a A2C automáticamente

---

## PASO 3: MONITOREAR PROGRESO (OPCIONAL)

### En otra terminal PowerShell:
```bash
cd d:\diseñopvbesscar
watch -n 10 'ls -ltr analyses/oe3/training/checkpoints/ppo/ | tail -10'
```

O más simple (Windows):
```bash
cd d:\diseñopvbesscar
:loop
cls
dir /s /b analyses\oe3\training\checkpoints\ppo\ppo_step_*.zip | sort
timeout /t 10
goto loop
```

### Qué ver
- Archivos ppo_step_500.zip, ppo_step_1000.zip, etc.
- Tamaño: ~2.5 MB cada uno
- Timestamps actualizándose

---

## PASO 4: CUANDO TERMINA PPO

### Se espera que A2C corra automáticamente
- Si corre automáticamente: Perfecto ✓
- Si NO corre: Ejecutar manualmente:
  ```bash
  python -m scripts.run_oe3_simulate --config configs/default.yaml
  ```

---

## PASO 5: GENERAR TABLA FINAL

### Cuando A2C termine:
```bash
python -m scripts.run_oe3_co2_table --config configs/default.yaml
```

### Resultado esperado
- Archivo: `analyses/oe3/co2_comparison_table.csv`
- Contenido: Tabla comparativa SAC vs PPO vs A2C vs Uncontrolled
- Métrica principal: CO₂ reduction (%)

---

## SI ALGO SALE MAL

### Si PPO aún falla:
```yaml
# Opción más conservadora:
oe3:
  evaluation:
    ppo:
      device: cpu
      use_amp: false
      timesteps: 20000         # Aún más reducido
      batch_size: 32           # Ultra conservador
      n_steps: 256             # Ultra conservador
```

### Si says "Dataset error":
```bash
python -m scripts.run_oe3_build_dataset --config configs/default.yaml
python -m scripts.run_oe3_simulate --config configs/default.yaml
```

---

## VERIFICACIÓN RÁPIDA

Antes de ejecutar, verificar que los cambios se hicieron:
```bash
cd d:\diseñopvbesscar
.venv\Scripts\python.exe -c "
import yaml
with open('configs/default.yaml') as f:
    ppo = yaml.safe_load(f)['oe3']['evaluation']['ppo']
    print(f'device: {ppo[\"device\"]}')
    print(f'use_amp: {ppo[\"use_amp\"]}')
    print(f'timesteps: {ppo[\"timesteps\"]}')
"
```

Esperado output:
```
device: cpu
use_amp: False
timesteps: 40000
```

---

## RESUMEN

| Paso | Acción | Tiempo |
|------|--------|--------|
| 1 | Editar configs/default.yaml | 2 min |
| 2 | Ejecutar PPO en CPU | 10-15 min |
| 3 | Monitor checkpoints | (opcional) |
| 4 | A2C runs automático | 15 min |
| 5 | Generar CO2 table | 5 min |
| **Total** | | **35-45 min** |

---

## CONFIRMACIÓN FINAL

✓ Diagnóstico probó que PPO funciona en CPU sin errores
✓ Cambios son mínimos (solo 5 líneas en config)
✓ Tiempo estimado total: 40-45 minutos
✓ Probabilidad de éxito: 95%

**¡Estás listo para proceder!**
